name '<%= params[:name] %>',
bucket '<%= params[:s3_bucket] %>'

bootstrap do |configuration|
  configuration.protect config['protected']
  configuration.kms_key '<%= params[:kms_key] %>'
  configuration.hosted_zone_id '<%= params[:hosted_zone_id] %>'

  configuration.ec2 do |ec2|
    ec2.key_pair '<%= params[:ec2_key_pair] %>'
    ec2.private_key 'ec2/private-key.pem'
  end

  configuration.vpc do |vpc|
    vpc.cidr '10.0.0.0/16'

    vpc.subnet 'management1' do |subnet|
      subnet.availability_zone '<%= params[:availability_zone] %>'
      subnet.cidr '10.0.0.0/24'
      subnet.public true do |acl|
        acl.source_ip '<%= ip %>'
      end
    end

    vpc.subnet 'public1' do |subnet|
      subnet.availability_zone '<%= params[:availability_zone] %>'
      subnet.cidr '10.0.1.0/24'
      subnet.public true
    end

    vpc.subnet 'private1' do |subnet|
      subnet.availability_zone '<%= params[:availability_zone] %>'
      subnet.cidr '10.0.2.0/24'
    end
  end

  configuration.bastion do |bastion|
    bastion.subnet 'management1'
    bastion.sub_domain config['bastion']['sub_domain']
    bastion.instance_cookbook 'bastion_instance'
  end

  configuration.nat do |nat|
    nat.subnet 'public1'
    nat.sub_domain config['nat']['sub_domain']
    nat.instance_cookbook 'nat_instance'
  end

  configuration.chef_server do |chef_server|
    chef_server.subnet 'management1'
    chef_server.sub_domain config['chef_server']['sub_domain']
    chef_server.instance_cookbook 'chef_server_instance'
    chef_server.cookbooks_bucket config['chef_server']['cookbooks_bucket']
    chef_server.organization '<%= params[:chef_server][:organization] %>'
    chef_server.username '<%= params[:chef_server][:username] %>'
    chef_server.email '<%= params[:chef_server][:email] %>'
    chef_server.first_name '<%= params[:chef_server][:first_name] %>'
    chef_server.last_name '<%= params[:chef_server][:last_name] %>'
    chef_server.password '<%= params[:chef_server][:password] %>'
    chef_server.ssl_key config['chef_server']['ssl']['key']
    chef_server.ssl_cert config['chef_server']['ssl']['cert']
    chef_server.ssl_verify config['chef_server']['ssl']['verify']
  end
end
